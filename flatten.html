<!DOCTYPE html>
<html  >
<head>
  
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <link rel="shortcut icon" href="assets/images/tigress-white-128x101.png" type="image/x-icon">
  <meta name="description" content="Web Page Creator Description">
  
  
  <title>empty</title>
  <link rel="stylesheet" href="assets/web/assets/mobirise-icons/mobirise-icons.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="assets/tether/tether.min.css">
  <link rel="stylesheet" href="assets/popup-overlay-plugin/style.css">
  <link rel="stylesheet" href="assets/dropdown/css/style.css">
  <link rel="stylesheet" href="assets/theme/css/style.css">
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Rubik:300,400,500,600,700,800,900,300i,400i,500i,600i,700i,800i,900i&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Rubik:300,400,500,600,700,800,900,300i,400i,500i,600i,700i,800i,900i&display=swap"></noscript>
  <link rel="preload" as="style" href="assets/mobirise/css/mbr-additional.css"><link rel="stylesheet" href="assets/mobirise/css/mbr-additional.css" type="text/css">

  
  
  
</head>
<body>
  
  <section class="menu cid-umo90uRXnp" once="menu" id="menu1-dh">

    

    <nav class="navbar navbar-expand beta-menu navbar-dropdown align-items-center navbar-fixed-top navbar-toggleable-sm">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
        <div class="menu-logo">
            <div class="navbar-brand">
                <span class="navbar-logo">
                    <a href="index.html">
                         <img src="assets/images/tigress-white-copy-1-154x122.png" alt="" title="" style="height: 3.8rem;">
                    </a>
                </span>
                <span class="navbar-caption-wrap"><a class="navbar-caption text-white display-4" href="index.html">
                        Tigress</a></span>
            </div>
        </div>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown nav-right" data-app-modern-menu="true"><li class="nav-item">
                    <a class="nav-link link text-white display-4" href="index.html">
                        
                        Home</a>
                </li><li class="nav-item dropdown">
                    <a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">Usage</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="quickstart.html">Quickstart<br></a><a class="text-white dropdown-item text-primary display-4" href="mergeFiles.html">File merge<br></a><a class="text-white dropdown-item text-primary display-4" href="crossCompile.html">Cross compile</a><a class="text-white dropdown-item text-primary display-4" href="recipes.html">Recipes</a><a class="text-white dropdown-item text-primary display-4" href="recipies.html">Libraries</a><a class="text-white dropdown-item text-primary display-4" href="bugs.html">Issues</a><a class="text-white dropdown-item text-primary display-4" href="testing.html">Testing</a></div>
                </li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">Platforms</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="linux.html">Linux<br></a><a class="text-white dropdown-item text-primary display-4" href="macos.html">MaxOS<br></a><a class="text-white dropdown-item text-primary display-4" href="windows.html">Windows<br></a><a class="text-white dropdown-item text-primary display-4" href="android.html">Android<br></a><a class="text-white dropdown-item text-primary display-4" href="wasm.html">WASM<br></a></div></li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">Users</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="academics.html">For academics<br></a><a class="text-white dropdown-item text-primary display-4" href="students.html">For students<br></a><a class="text-white dropdown-item text-primary display-4" href="practitioners.html">For practitioners<br></a><a class="text-white dropdown-item text-primary display-4" href="developers.html">For developers<br></a></div></li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">Transformations</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="overview.html">Overview</a><a class="text-white dropdown-item text-primary display-4" href="control.html">Control</a><a class="text-white dropdown-item text-primary display-4" href="data.html">Data</a><a class="text-white dropdown-item text-primary display-4" href="functions.html">Functions</a><a class="text-white dropdown-item text-primary display-4" href="integrity.html">Integrity</a><a class="text-white dropdown-item text-primary display-4" href="environment.html">Environment</a><a class="text-white dropdown-item text-primary display-4" href="antiAnalysis.html">Anti analysis</a><a class="text-white dropdown-item text-primary display-4" href="other.html">Other</a></div></li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">Info</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="news.html">News<br></a><a class="text-white dropdown-item text-primary display-4" href="blog.html">Blog<br></a><a class="text-white dropdown-item text-primary display-4" href="FAQ.html">FAQ</a><a class="text-white dropdown-item text-primary display-4" href="publications.html">Pubs<br></a></div></li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">About</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="about.html">History<br></a><a class="text-white dropdown-item text-primary display-4" href="consulting.html">Training<br></a><a class="text-white dropdown-item text-primary display-4" href="contact.html">Contact</a></div></li><li class="nav-item"><a class="nav-link link text-white text-primary display-4" href="download4.html" aria-expanded="false">Download</a></li></ul>
            
        </div>
    </nav>
</section>


<br><br><br><br>
<center><h1>Flatten</h1></center>

<center><img width="500px" src="tigress3-images/flatten-front-page.png"></center>

<a class="anchor" id="flatten">&nbsp;</a>
<p>This is a classic control-flow transformation that removes structured flow.</a>
<center>
<video  width="630" height="360" controls style="border:5px solid black;">
  <source src="tigress3-videos/flatten.m4v" type="video/mp4">
  Your browser does not support the video tag.
</video>
</center>

<p>Flattening is useful as a precursor to other transformations. For example, our
<a href="encodeBranches.html">AntiBranchAnalysis</a> transformation
flattens a function prior to replacing direct branches by calls to a
branch function since this creates more opportunities for encoding.
Also, the <a href="merge.html">Merge</a> transformation can optionally
flatten functions before merging them, thus more thoroughly mixing
their code.</p>

<center>
<div style="mbr-text align-left pb-3 mbr-fonts-style display-7">
<table border style="background-color:#f5f5f5;overflow-x:auto;color:black;width:80%;">
    <colgroup>
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 60%;">
    </colgroup>
<tr><th>Option</th><th>Arguments</th><th>Description</th></tr>
<tr>
<td><tt>--Transform</tt></td>
<td><tt>Flatten</tt></td>
<td> Flatten a function using Chenxi Wang's algorithm </td>
</tr>
<tr>
<td><tt>--FlattenDumpBlocks</tt></td>
<td><tt><em><a href="top-level.html#BOOLSPEC">BOOLSPEC</a></em></tt></td>
<td> Print the linearized blocks. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenSplitBasicBlocks</tt></td>
<td><tt><em><a href="top-level.html#BOOLSPEC">BOOLSPEC</a></em></tt></td>
<td> If true, then basic blocks (sequences of assignment and call statements without intervening branches) will be split up into indiviual blocks. If false, they will be kept intact. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenRandomizeBlocks</tt></td>
<td><tt><em><a href="top-level.html#BOOLSPEC">BOOLSPEC</a></em></tt></td>
<td> If true, then basic block sequences will be randomized. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenTrace</tt></td>
<td><tt>blocks, check, *</tt></td>
<td> Print a message before each block gets executed. Useful for debugging. Prior to version <b>3.3.3</b> this used to be a boolean. Default=print nothing.
<ul>
   <li> <tt>blocks</tt> = print a message before each block gets executed
   <li> <tt>check</tt> = insert extra checks, such as hitting <tt>default</tt> in a switch dispatch
   <li> <tt>*</tt> = select all options
</ul>
</td>
</tr>
</table>
</div>

</center>
</br>

<a class="anchor" id="diversity">&nbsp;</a>
<br>
<h3 align=center>Diversity</h3>
<p>There are several sources of diversity:</p>
<ul>
   <li> We support five kinds of "dispatch," i.e. how the next block is selected.</li>
   <li> Basic blocks can be kept intact, or can be split up into individual statements.</li>
   <li> The order of blocks can be randomized.</li>
   <li> The <code>next</code> variable can be obfuscated using different kinds of opaque predicates.</li>
   <li> Conditional branches can be encoded in several different ways. </li>

<a class="anchor" id="dispatch">&nbsp;</a>
<br>
<h3 align=center>Dispatch</h3>
<p>These are the four basic kinds of block dispatch we currently support, and 
what a reursive factorial function looks like after transformation:</p>
<ul>
   <li> In a <em>switch dispatch</em>, each block becomes a case in a switch statement,
        and the switch is wrapped inside an infinite loop. This is the traditional
        implementation. 
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">int fac(int x) { 
  int tmp ;
  unsigned long next ;
  next = 4;
  while (1) {
    switch (next) {
    case 4: 
    if (x == 1) {
      next = 3;
    } else {
      next = 2;
    }
    break;
    case 3: return (1); break;
    case 2: tmp = fac(x - 1); next = 1; break;
    case 1: return (x * tmp); break;
    }
  }
}
</code></pre>
   <li> In a <em>goto dispatch</em>, direct gotos are used to jump between blocks. 
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">int fac(int x) { 
  int tmp ;
  goto lab4;
  lab4: 
  if (! (x == 1)) {
    goto lab2;
  }
  lab3: 
  return (1);
  lab2: 
  tmp = fac(x - 1);
  goto lab1;
  lab1: 
  return (x * tmp);
}
</code></pre>
   <li> In an <em>indirect dispatch</em>, indirect gotos through a jump table are used to switch between blocks. 
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">int fac(int x) { 
  int tmp ;
  unsigned long next ;
  static void *jumpTab[4]  = {&& lab1, && lab2, && lab3, && lab4};
  next = 4;
  goto *(jumpTab[next - 1]);
  lab4:
  if (x == 1) {
    next = 3;
  } else {
    next = 2;
  }
  goto *(jumpTab[next - 1]);
  lab3: 
  return (1);
  goto *(jumpTab[next - 1]);
  lab2: 
  tmp = fac(x - 1);
  next = 1;
  goto *(jumpTab[next - 1]);
  lab1:
  return (x * tmp);
  goto *(jumpTab[next - 1]);
}
</code></pre>
   <li> In a <em>call dispatch</em>, each block becomes its own function, and indirect calls through a 
        table of function pointers are used to switch between blocks. 
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">struct argStruct {
   int tmp ;
   int *x ;
   int returnv ;
   unsigned long next ;
};

void block_1(struct argStruct *arg ) { 
  arg->returnv = *(arg->x) * arg->tmp;
  arg->next = 5;
  return;
}

void block_2(struct argStruct *arg ) { 
  arg->tmp = fac(*(arg->x) - 1);
  arg->next = 1;
  return;
}

void block_4(struct argStruct *arg ) { 
  if (*(arg->x) == 1) {
    arg->next = 3;
  } else {
    arg->next = 2;
  }
  return;
}

void block_3(struct argStruct *arg ) { 
  arg->returnv = 1;
  arg->next = 5;
  return;
}

int fac(int x ){ 
  struct argStruct arg ;
  static void (*jumpTab[4])(struct argStruct *arg )  = {& block_1, & block_2,& block_3, & block_4};
  arg.next = 4;
  arg.x = & x;
  while (1) {
    if (arg.next > 4) {
      return (arg.returnv);
    } else {
      (*(jumpTab[arg.next - 1]))(& arg);
    }
  }
}
</code></pre>

<br>
<h3 align=center>Thread Dispatch <b>From Version 3.3.3</b></h3>
<p>These is a fifth block dispatch method which we call <tt>thread</tt>. It is essentially identical to
the <tt>call</tt> dispatch, except each call runs in its own thread. The idea is that every time
around the dispatch loop <em>all</em> threads are awakened, and <em>all of them</em> do some work, but
only <em>one</em> thread (the one that owns the next block to be executed) actually does any
<em>real</em> work. This way there is some randomness in the order in which the block functions
execute, but there is no potential for race conditions on the <tt>next</tt> variable (only one
thread will update <tt>next</tt> during each round). </p> 

<p>
This is what the code looks like for the main function that got flattened.
MacOS does not support barriers, so we roll our own. 
</p>
<center>
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">void fib(int n ) { 
  struct argStruct arg ;
  pthread_t thrds[3];
  pthread_mutex_init(&arg.mtx, NULL);
  pthread_cond_init(&arg.cv, NULL);

  /* Create the threads. */
  pthread_create(&thrds[0], NULL, &fib_0, (void*)& arg);
  pthread_create(&thrds[1], NULL, &fib_1, (void*)& arg);
  pthread_create(&thrds[2], NULL, &fib_2, (void*)& arg);

  arg.fib_next = 3UL;  /* State machine variable. ==6 when end state reached. */
  arg.fib_done = 0UL;  /* How we flag the workers they should die. */
  arg.n = & n;
  while (1) {
      /* Wake up all the threads and run one iteration of the state machine. */
      pthread_mutex_lock(&arg.mtx);
         arg.jobs_in_progress = <word with 3 first bits set, i.e. 0b111 for 3 threads> ;
         pthread_cond_broadcast(&arg.cv);
      pthread_mutex_unlock(&arg.mtx);

      pthread_mutex_lock(&arg.mtx);
         while (arg.jobs_in_progress != 0) {
            pthread_cond_wait(&arg.cv, &arg.mtx);
         };
      pthread_mutex_unlock(&arg.mtx);

      /* One of the threads have set fib_next==6, this means we've
         reached an end state. We're done, kill the threads. */
      if (arg.fib_next == 6) {
         arg.fib_done = 1;
         pthread_mutex_lock(&arg.mtx);
         pthread_cond_broadcast(&arg.cv);
         pthread_mutex_unlock(&arg.mtx);

         /* Wait for the threads to die. */
         for (int i=0; i<3; i++) {
            pthread_join(thrds[i], NULL);
         };
         pthread_mutex_destroy(&arg.mtx);
         return;
      }
   }
}
</code></pre>
</center>

<p>
And this is what one of the worker threads look like.
</p>
<center>
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">void fib_0_<n> (struct argStruct *arg ) { 
  while (1) {
     /* Wait for work to arrive. */
     pthread_mutex_lock(&arg->mtx);
     while (!((arg->jobs_in_progress & <word with bit 0 set> || (arg->fib_done))) {
         pthread_cond_wait(&arg->cv, &arg->mtx);
     };
     pthread_mutex_unlock(&arg->mtx);

     /* Time to die. */
     if (arg->fib_done) return;

     /* Do the work assigned to us. */
     switch (arg->fib_next) {
        case 4: {
           /* This is the end state, we're done. */
           arg->fib_next = 6UL;
           break;
       }
        case 1: {
           ...
        }
     }
     /* Let the everyone know we're done. */
     pthread_mutex_lock(&arg->mtx);
     arg->jobs_in_progress = arg->jobs_in_progress & ~ <word with bit 0 set>;
     pthread_cond_broadcast(&arg->cv);
     pthread_mutex_unlock(&arg->mtx);
   }
}
</center>
</code></pre>

<p>
Threaded flattening should work well with other transformations. For example, you can first
virtualize your function and then flatten it with a threaded dispatch: this results in a 
in interpreter where each instruction handler (or piece of instruction handler) will run
in its own thread. You can even flatten the same function twice, with threaded dispatch
both times.
</p>

<p>We're currently using <tt>pthreads</tt> which is unfortunate, because the calls to the
various API functions are obvious in the code (and at runtime). It would be nice to replace
these functions with some lower-level primitives.
</p>

<center>
<div style="mbr-text align-left pb-3 mbr-fonts-style display-7">
<table border style="background-color:#f5f5f5;overflow-x:auto;color:black;width:80%;">
    <colgroup>
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 60%;">
    </colgroup>
<tr><th>Option</th><th>Arguments</th><th>Description</th></tr>
<tr>
<td><tt>--FlattenDispatch</tt></td>
<td><tt>switch, goto, indirect, call, concurrent, *</tt></td>
<td> Dispatch method. Comma-separated list. Default=switch.
<ul>
   <li> <tt>switch</tt> = dispatch by <tt>while(1) {switch (next) {blocks}}</tt>
   <li> <tt>goto</tt> = dispatch by <tt>{labl1: block1; goto block2;}</tt>
   <li> <tt>indirect</tt> = dispatch by <tt>goto* (jtab[next])</tt>
   <li> <tt>call</tt> = each block is outlined into its own function
   <li> <tt>concurrent</tt> = like call, but each function runs in its own thread. <b>From Version 3.3.3</b>
   <li> <tt>*</tt> = select a dispatch method at random.
</ul>
</td>
</tr>
<tr>
<td><tt>--FlattenNumberOfThreads</tt></td>
<td><tt><em><a href="top-level.html#INTSPEC">INTSPEC</a></em></tt></td>
<td> The number of threads created for concurrent dispatch. Default=1.</td>
</tr>
<tr>
<td><tt>--FlattenSplitName</tt></td>
<td><tt>string</tt></td>
<td> The name of the functions generated for call dispatch. Default=SPLIT.</td>
</tr>
</table>
</div>

</center>
</br>

<a class="anchor" id="conditionals">&nbsp;</a>
<br>
<h3 align=center>Conditional Branches</h3>
<p>If the <code>--FlattenConditionalKinds=flag</code> is set, there will be no
explicit conditional tests in the code. Rather, they will be transformed
into an assembly code snippet (<code>x86</code> only, at this point) that 
does the comparison, extracts the flag register, and then the address to
jump to will be computed based on the individual flags set. Similar
encodings are available for Merge and Virtualize transformations.</p>

<center>
<div style="mbr-text align-left pb-3 mbr-fonts-style display-7">
<table border style="background-color:#f5f5f5;overflow-x:auto;color:black;width:80%;">
    <colgroup>
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 60%;">
    </colgroup>
<tr><th>Option</th><th>Arguments</th><th>Description</th></tr>
<tr>
<td><tt>--FlattenConditionalKinds</tt></td>
<td><tt>branch, compute, flag</tt></td>
<td> Ways to transform conditional branches. Default=branch.
<ul>
   <li> <tt>branch</tt> = Use normal branches, such as <tt>if (a>b) goto L1 else goto L2</tt>
   <li> <tt>compute</tt> = Compute the branch, such as <tt>x=(a>b); goto *(<em>expression over <tt>x</tt></em>)</tt>
   <li> <tt>flag</tt> = Compute the branch from the values of the flag register, such as <tt>asm("cmp a b;pushf;pop"); goto *(<em>expression over <tt>flag register</tt></em>)</tt>
</ul>
</td>
</tr>
</table>
</div>

</center>
</br>

<a class="anchor" id="nextobf">&nbsp;</a>
<br>
<h3 align=center>Obfuscating the Next Variable</h3>
<p>You can use opaque predicates and anti-implicit flow transformations to further obfuscate the <code>next</code>
variable.</p>

<center>
<div style="mbr-text align-left pb-3 mbr-fonts-style display-7">
<table border style="background-color:#f5f5f5;overflow-x:auto;color:black;width:80%;">
    <colgroup>
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 60%;">
    </colgroup>
<tr><th>Option</th><th>Arguments</th><th>Description</th></tr>
<tr>
<td><tt>--FlattenObfuscateNext</tt></td>
<td><tt><em><a href="top-level.html#BOOLSPEC">BOOLSPEC</a></em></tt></td>
<td> Whether the dispatch variable should be obfuscated with opaque expressions or not. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenOpaqueStructs</tt></td>
<td><tt>list, array, *</tt></td>
<td> Type of opaque predicate to use. Traditionally, for this transformation, <tt>array</tt> is used. Default=array.
<ul>
   <li> <tt>list</tt> = Generate opaque expressions using linked lists
   <li> <tt>array</tt> = Generate opaque expressions using arrays
   <li> <tt>*</tt> = Same as list,array
</ul>
</td>
</tr>
<tr>
<td><tt>--FlattenImplicitFlowNext</tt></td>
<td><tt>bool</tt></td>
<td> Insert implicit flow between the computation of a an address and the subsequent indirect jump or call. This applies to <tt>call</tt> and <tt>indirect</tt> transformations only. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenImplicitFlow</tt></td>
<td><tt>S-Expression</tt></td>
<td> The type of implicit flow to insert. See <tt>--AntiTaintAnalysisImplicitFlow</tt> for a description. Default=none.</td>
</tr>
</table>
</div>

</center>
</br>


<!-- -------------------------------------------------------------------------------- -->

<a class="anchor" id="regions">&nbsp;</a>
<br>
<h3 align=center>Function Regions</h3>
<p>You can virtualize a piece of a function, rather than the whole thing. Simpy put 
   the name of the region after the function name, like this: </p>

<center>
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">tigress ... --Transform=Flatten  --Functions=fac:region2 ...
</code></pre>
</center>

<p>The region has to be defined like this in the code: </p>

<center>
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">#include "tigress.h"

void fac(int n) {
  int s=1;
  int i;
  for (i=2; i<=n; i++) {
    TIGRESS_REGION(region2,
      s *= i;
    );
  }
  printf("fac(%i)=%i\n",n,s);
}
</code></pre>
</center>

<p>Note that the region needs to be ``self-contained,'' i.e. you can't jump into it, or out of it.
   Also, there will be some performance overhead.</p>

<!-- -------------------------------------------------------------------------------- -->

<a class="anchor" id="issues">&nbsp;</a>
<br>
<h3 align=center>Issues</h3>
<ul>
   <li> Consider this example taken from gcc's <code>comp-goto-1.c</code> torture test:
<center>
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">goto *(base_addr + insn.f1.offset);
</code></pre>
</center>
      This kind of arithmetic on the program counter is going to fail for 
      transformations that completely restructure the code, such as
      flattening.
   <li> The <code>--FlattenConditionalKinds=flag</code> transformation doesn't
      work for floats, for reasons that escape me. I think maybe floats are
      left on the stack and then there's a SEGV when the function returns,
      but who knows? <code>:(</code>.</li>
   <li> On MacOS/llvm the <code>--FlattenDispatch=call --FlattenConditionalKinds=flag</code> transformation 
      generates a segmentation fault, on Linux/gcc it does not. There are other similar issues that 
      pop up occasionally on this platform. Presumably this is due to some compiler problem related 
      to inline assembly. Update: I think this has been fixed now. Inline assembly with instructions
      that manipulate the stack pointer can apparently be problematic.</li>
   <li> By default, Flatten transforms Variable Length Arrays into calls to <code>alloca</code>. Depending on the 
       platform and the size of the arrays, the generated code can crash. If so, try the option
       <code>--TransformVLA=malloc</code> which converts VLAs to calls to <code>malloc/free</code> instead.</li>

<!-- -------------------------------------------------------------------------------- -->

<a class="anchor" id="acknowledgments">&nbsp;</a>
<br>
<h3 align=center>Acknowledgments</h3>
<p>Saumya Debray and Babak Yadegari suggested the <code>--FlattenConditionalKinds=flag</code> transformation.</p>

<a class="anchor" id="references">&nbsp;</a>
<br>
<h3 align=center>References</h3>
<ul>
   <li> Flattening first appears in Chenxi Wang's <a href="http://dependability.cs.virginia.edu/publications/wangthesis.pdf">thesis.</a>
   <li> The <a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening">llvm obfuscator</a>
        supports a flattening transformation.
   <li> Laszlo and Kiss, <a href="http://www.inf.u-szeged.hu/~akiss/pub/pdf/laszlo_obfuscating.pdf">Obfuscating C++ Programs via Control Flow Flattening</a>
   <li> Udupa et al, <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.302.7805">Deobfuscation: Reverse engineering obfuscated code</a>.


<script src="assets/popper/popper.min.js"></script>
  <script src="assets/web/assets/jquery/jquery.min.js"></script>
  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/tether/tether.min.js"></script>
  <script src="assets/smoothscroll/smooth-scroll.js"></script>
  <script src="assets/dropdown/js/nav-dropdown.js"></script>
  <script src="assets/dropdown/js/navbar-dropdown.js"></script>
  <script src="assets/touchswipe/jquery.touch-swipe.min.js"></script>
  <script src="assets/theme/js/script.js"></script>
  
  
  
</body>
</html>
