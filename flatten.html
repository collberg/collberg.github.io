<!DOCTYPE html>
<html  >
<head>
  <!-- Site made with Mobirise Website Builder v4.10.10, https://mobirise.com -->
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Mobirise v4.10.10, mobirise.com">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <link rel="shortcut icon" href="assets/images/tigress-white-128x101.png" type="image/x-icon">
  <meta name="description" content="Web Generator Description">
  
  <title>Transformation:Virtualize</title>
  <link rel="preload" as="style" href="assets/web/assets/mobirise-icons/mobirise-icons.css">
<link rel="stylesheet" href="assets/web/assets/mobirise-icons/mobirise-icons.css">
  <link rel="preload" as="style" href="assets/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="preload" as="style" href="assets/bootstrap/css/bootstrap-grid.min.css">
<link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
  <link rel="preload" as="style" href="assets/bootstrap/css/bootstrap-reboot.min.css">
<link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="assets/tether/tether.min.css">
  <link rel="stylesheet" href="assets/dropdown/css/style.css">
  <link rel="stylesheet" href="assets/theme/css/style.css">
  <link rel="preload" as="style" href="assets/mobirise/css/mbr-additional.css"><link rel="stylesheet" href="assets/mobirise/css/mbr-additional.css" type="text/css">
  
  
  

</head>
<body>
  <section class="menu cid-rCFaEeaKON" once="menu" id="menu1-h">

    

    <nav class="navbar navbar-expand beta-menu navbar-dropdown align-items-center navbar-fixed-top navbar-toggleable-sm">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
        <div class="menu-logo">
            <div class="navbar-brand">
                <span class="navbar-logo">
                    <a href="index.html">
                         <img src="assets/images/tigress-white-copy-154x122.png" alt="Mobirise" title="" style="height: 3.8rem;">
                    </a>
                </span>
                <span class="navbar-caption-wrap"><a class="navbar-caption text-white display-4" href="index.html">
                        Tigress</a></span>
            </div>
        </div>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown nav-right" data-app-modern-menu="true"><li class="nav-item">
                    <a class="nav-link link text-white display-4" href="index.html">
                        
                        Home</a>
                </li><li class="nav-item">
                    <a class="nav-link link text-white display-4" href="introduction.html">
                        
                        Introduction</a>
                </li><li class="nav-item"><a class="nav-link link text-white display-4" href="usage.html">Usage</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="transformations.html">Transformations</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="publications.html">Publications</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="FAQ.html">FAQ</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="consulting.html">Consulting/Training</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="about.html">About</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="contact.html">Contact</a></li></ul>
            
        </div>
    </nav>
</section>

<br><br><br>

<a class="anchor" id="flatten">&nbsp;</a>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-rCVze1lAFM" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7">This is a classic control-flow transformation that removes structured flow.</a>
<center>
<video  width="630" height="360" controls style="border:5px solid black;">
  <source src="tigress3-videos/flatten.m4v" type="video/mp4">
  Your browser does not support the video tag.
</video>
</center>

<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-rCVze1lAFM" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7">Flattening is useful as a precursor to other transformations. For example, our
<a href="http://tigress.cs.arizona.edu/transformPage/docs/encodeBranches/index.html">AntiBranchAnalysis</a>
transformation flattens a function prior to replacing direct branches
by calls to a branch function since this creates more opportunities
for encoding.  Also,
the <a href="http://tigress.cs.arizona.edu/transformPage/docs/merge/index.html">Merge</a>
transformation can optionally flatten functions before merging them,
thus more thoroughly mixing their code.</p></div></div></section>

<a class="anchor" id="diversity">&nbsp;</a>
<h3 align=center>Diversity</h3>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-rCVze1lAFM" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7">There are several sources of diversity:</p></div></div></section>
<br>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; We support four kinds of "dispatch," i.e. how the next block is selected.
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; Basic blocks can be kept intact, or can be split up into individual statements.
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; The order of blocks can be randomized.
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; The <tt>next</tt> variable can be obfuscated using different kinds of opaque predicates.
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; Conditional branches can be encoded in several different ways. 
<br>

<a class="anchor" id="dispatch">&nbsp;</a>
<h3 align=center>Dispatch</h3>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-rCVze1lAFM" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7">These are the four kinds of block dispatch we currently support, and 
what a reursive factorial function looks like after transformation:</p></div></div></section>
<br>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; In a <em>switch dispatch</em>, each block becomes a case in a switch statement,
        and the switch is wrapped inside an infinite loop. This is the traditional
        implementation. 
<div style="width:800px;overflow:auto;margin:5px;border:1px solid black;bottommargin:0px">
<pre><code>int fac(int x) { 
  int tmp ;
  unsigned long next ;
  next = 4;
  while (1) {
    switch (next) {
    case 4: 
    if (x == 1) {
      next = 3;
    } else {
      next = 2;
    }
    break;
    case 3: return (1); break;
    case 2: tmp = fac(x - 1); next = 1; break;
    case 1: return (x * tmp); break;
    }
  }
}
</code></pre>
</div>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; In a <em>goto dispatch</em>, direct gotos are used to jump between blocks. 
<div style="width:800px;overflow:auto;margin:5px;border:1px solid black;bottommargin:0px">
<pre><code>int fac(int x) { 
  int tmp ;
  goto lab4;
  lab4: 
  if (! (x == 1)) {
    goto lab2;
  }
  lab3: 
  return (1);
  lab2: 
  tmp = fac(x - 1);
  goto lab1;
  lab1: 
  return (x * tmp);
}
</code></pre>
</div>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; In an <em>indirect dispatch</em>, indirect gotos through a jump table are used to switch between blocks. 
<div style="width:800px;overflow:auto;margin:5px;border:1px solid black;bottommargin:0px">
<pre><code>int fac(int x) { 
  int tmp ;
  unsigned long next ;
  static void *jumpTab[4]  = {&& lab1, && lab2, && lab3, && lab4};
  next = 4;
  goto *(jumpTab[next - 1]);
  lab4:
  if (x == 1) {
    next = 3;
  } else {
    next = 2;
  }
  goto *(jumpTab[next - 1]);
  lab3: 
  return (1);
  goto *(jumpTab[next - 1]);
  lab2: 
  tmp = fac(x - 1);
  next = 1;
  goto *(jumpTab[next - 1]);
  lab1:
  return (x * tmp);
  goto *(jumpTab[next - 1]);
}
</code></pre>
</div>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; In a <em>call dispatch</em>, each block becomes its own function, and indirect calls through a 
        table of function pointers are used to switch between blocks. 
<div style="width:800px;overflow:auto;margin:5px;border:1px solid black;bottommargin:0px">
<pre><code>struct argStruct {
   int tmp ;
   int *x ;
   int returnv ;
   unsigned long next ;
};

void block_1(struct argStruct *arg ) { 
  arg->returnv = *(arg->x) * arg->tmp;
  arg->next = 5;
  return;
}

void block_2(struct argStruct *arg ) { 
  arg->tmp = fac(*(arg->x) - 1);
  arg->next = 1;
  return;
}

void block_4(struct argStruct *arg ) { 
  if (*(arg->x) == 1) {
    arg->next = 3;
  } else {
    arg->next = 2;
  }
  return;
}

void block_3(struct argStruct *arg ) { 
  arg->returnv = 1;
  arg->next = 5;
  return;
}

int fac(int x ){ 
  struct argStruct arg ;
  static void (*jumpTab[4])(struct argStruct *arg )  = {& block_1, & block_2,& block_3, & block_4};
  arg.next = 4;
  arg.x = & x;
  while (1) {
    if (arg.next > 4) {
      return (arg.returnv);
    } else {
      (*(jumpTab[arg.next - 1]))(& arg);
    }
  }
}
</code></pre>
</div>
<br>

<a class="anchor" id="conditionals">&nbsp;</a>
<h3 align=center>Conditional Branches</h3>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-rCVze1lAFM" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7">If the <tt>--FlattenConditionalKinds=flag</tt> is set, there will be no
explicit conditional tests in the code. Rather, they will be transformed
into an assembly code snippet (<tt>x86</tt> only, at this point) that 
does the comparison, extracts the flag register, and then the address to
jump to will be computed based on the individual flags set. Similar
encodings are availablef for the 
the <a href="http://tigress.cs.arizona.edu/transformPage/docs/merge/index.html">Merge</a>
and
the <a href="http://tigress.cs.arizona.edu/transformPage/docs/virtualize/index.html">Virtualize</a>
transformations.</p></div></div></section>

<a class="anchor" id="options">&nbsp;</a>
<h3 align=center>Options</h3>
INPUT options.html

<a class="anchor" id="issues">&nbsp;</a>
<h3 align=center>Issues</h3>
<br>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; Consider this example taken from gcc's <tt>comp-goto-1.c</tt> torture test:
<div style="width:800px;overflow:auto;margin:5px;border:1px solid black;bottommargin:0px">
<pre><code>goto *(base_addr + insn.f1.offset);
</code></pre>
</div>
      This kind of arithmetic on the program counter is going to fail for 
      transformations that completely restructure the code, such as
      flattening.
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; The <tt>--FlattenConditionalKinds=flag</tt> transformation doesn't
      work for floats, for reasons that escape me. I think maybe floats are
      left on the stack and then there's a SEGV when the function returns,
      but who knows? <tt>:(</tt>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; On MacOS/llvm the <tt>--FlattenDispatch=call --FlattenConditionalKinds=flag</tt> transformation 
      generates a segmentation fault, on Linux/gcc it does not. There are other similar issues that 
      pop up occasionally on this platform. Presumably this is due to some compiler problem related 
      to inline assembly. Update: I think this has been fixed now. Inline assembly with instructions
      that manipulate the stack pointer can apparently be problematic.
<br>

<a class="anchor" id="acknowledgments">&nbsp;</a>
<h3 align=center>Acknowledgments</h3>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-rCVze1lAFM" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7">Saumya Debray and Babak Yadegari suggested the <tt>--FlattenConditionalKinds=flag</tt> transformation.</p></div></div></section>

<a class="anchor" id="references">&nbsp;</a>
<h3 align=center>References</h3>
<br>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; Flattening first appears in Chenxi Wang's <a href="http://dependability.cs.virginia.edu/publications/wangthesis.pdf">thesis.</a>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; The <a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening">llvm obfuscator</a>
        supports a flattening transformation.
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; Laszlo and Kiss, <a href="http://www.inf.u-szeged.hu/~akiss/pub/pdf/laszlo_obfuscating.pdf">Obfuscating C++ Programs via Control Flow Flattening</a>
   <br>&nbsp;&nbsp;&nbsp;&bull;&nbsp; Udupa et al, <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.302.7805">Deobfuscation: Reverse engineering obfuscated code</a>.
<br>



  <script src="assets/web/assets/jquery/jquery.min.js"></script>
  <script src="assets/popper/popper.min.js"></script>
  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
  <script async src="assets/tether/tether.min.js"></script>
  <script async src="assets/smoothscroll/smooth-scroll.js"></script>
  <script async src="assets/dropdown/js/nav-dropdown.js"></script>
  <script async src="assets/dropdown/js/navbar-dropdown.js"></script>
  <script async src="assets/touchswipe/jquery.touch-swipe.min.js"></script>
  <script async src="assets/theme/js/script.js"></script>
  
  

</body>
</html>
