<!DOCTYPE html>
<html  >
<head>
  <!-- Site made with Mobirise Website Builder v4.10.10, https://mobirise.com -->
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Mobirise v4.10.10, mobirise.com">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <link rel="shortcut icon" href="assets/images/tigress-white-128x101.png" type="image/x-icon">
  <meta name="description" content="Web Site Builder Description">
  
  <title>Flatten</title>
  <link rel="preload" as="style" href="assets/web/assets/mobirise-icons/mobirise-icons.css">
<link rel="stylesheet" href="assets/web/assets/mobirise-icons/mobirise-icons.css">
  <link rel="preload" as="style" href="assets/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="preload" as="style" href="assets/bootstrap/css/bootstrap-grid.min.css">
<link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
  <link rel="preload" as="style" href="assets/bootstrap/css/bootstrap-reboot.min.css">
<link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="assets/tether/tether.min.css">
  <link rel="stylesheet" href="assets/dropdown/css/style.css">
  <link rel="stylesheet" href="assets/animatecss/animate.min.css">
  <link rel="stylesheet" href="assets/theme/css/style.css">
  <link rel="preload" as="style" href="assets/mobirise/css/mbr-additional.css"><link rel="stylesheet" href="assets/mobirise/css/mbr-additional.css" type="text/css">
 
<style>
body {
  background-color: #ffffff;
  color: #000000
}
section {
  background-color: #ffffff;
  color: #000000
}
p {
   color: #767676
}
h3 {
   color: #767676
}
</style>

</head>
<body>

  <section class="menu cid-rCFaEeaKON" once="menu" id="menu1-v">

    

    <nav class="navbar navbar-expand beta-menu navbar-dropdown align-items-center navbar-fixed-top navbar-toggleable-sm">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
        <div class="menu-logo">
            <div class="navbar-brand">
                <span class="navbar-logo">
                    <a href="index.html">
                         <img src="assets/images/tigress-white-copy-154x122.png" alt="Mobirise" title="" style="height: 3.8rem;">
                    </a>
                </span>
                <span class="navbar-caption-wrap"><a class="navbar-caption text-white display-4" href="index.html">
                        Tigress</a></span>
            </div>
        </div>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown nav-right" data-app-modern-menu="true"><li class="nav-item">
                    <a class="nav-link link text-white display-4" href="index.html">
                        
                        Home</a>
                </li><li class="nav-item">
                    <a class="nav-link link text-white display-4" href="introduction.html">
                        
                        Introduction</a>
</li><li class="nav-item"><a class="nav-link link text-white display-4" href="usage.html">Usage</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="transformations.html">Transformations</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="recipes.html">Recipes</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="publications.html">Publications</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="blog.html">Blog</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="FAQ.html">FAQ</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="consulting.html">Training</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="about.html">About</a></li><li class="nav-item"><a class="nav-link link text-white display-4" href="contact.html">Contact</a></li></ul>
            
        </div>
    </nav>
</section>

<br><br><br><br>
<center><h1>Flatten</h1></center>

<center><img width="500px" src="tigress3-images/flatten-front-page.png"></center>

<a class="anchor" id="flatten">&nbsp;</a>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-c9559" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7" style="background-color:#ffffff">This is a classic control-flow transformation that removes structured flow.</a>
<center>
<video  width="630" height="360" controls style="border:5px solid black;">
  <source src="tigress3-videos/flatten.m4v" type="video/mp4">
  Your browser does not support the video tag.
</video>
</center>

<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-c9560" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7" style="background-color:#ffffff">Flattening is useful as a precursor to other transformations. For example, our
<a href="encodeBranches.html">AntiBranchAnalysis</a> transformation
flattens a function prior to replacing direct branches by calls to a
branch function since this creates more opportunities for encoding.
Also, the <a href="merge.html">Merge</a> transformation can optionally
flatten functions before merging them, thus more thoroughly mixing
their code.</p></div></div></section>

<center>
<div style="mbr-text align-left pb-3 mbr-fonts-style display-7">
<table border style="background-color:#f5f5f5;overflow-x:auto;color:black;width:80%;">
    <colgroup>
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 60%;">
    </colgroup>
<tr><th>Option</th><th>Arguments</th><th>Description</th></tr>
<tr>
<td><tt>--Transform</tt></td>
<td><tt>Flatten</tt></td>
<td> Flatten a function using Chenxi Wang's algorithm </td>
</tr>
<tr>
<td><tt>--FlattenDumpBlocks</tt></td>
<td><tt><em><a href="top-level.html#arguments">BOOLSPEC</a></em></tt></td>
<td> Print the linearized blocks. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenSplitBasicBlocks</tt></td>
<td><tt><em><a href="top-level.html#arguments">BOOLSPEC</a></em></tt></td>
<td> If true, then basic blocks (sequences of assignment and call statements without intervening branches) will be split up into indiviual blocks. If false, they will be kept intact. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenRandomizeBlocks</tt></td>
<td><tt><em><a href="top-level.html#arguments">BOOLSPEC</a></em></tt></td>
<td> If true, then basic block sequences will be randomized. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenTrace</tt></td>
<td><tt>bool</tt></td>
<td> Print a message before each block gets executed. Useful for debugging. Default=false.</td>
</tr>
</table>
</div>

</center>
</br>

<a class="anchor" id="diversity">&nbsp;</a>
<br>
<h3 align=center>Diversity</h3>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-c9561" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7" style="background-color:#ffffff">There are several sources of diversity:</p></div></div></section>
<section class="mbr-section article content12 cid-rDNq15ll1q" id="content12-d"><div class="container"><div class="media-container-row"><div class="mbr-text counter-container col-12 col-md-8 mbr-fonts-style display-7">
<ul>
   <li> We support four kinds of "dispatch," i.e. how the next block is selected.</li>
   <li> Basic blocks can be kept intact, or can be split up into individual statements.</li>
   <li> The order of blocks can be randomized.</li>
   <li> The <code>next</code> variable can be obfuscated using different kinds of opaque predicates.</li>
   <li> Conditional branches can be encoded in several different ways. </li>
</ul>
</div></div></div></section>

<a class="anchor" id="dispatch">&nbsp;</a>
<br>
<h3 align=center>Dispatch</h3>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-c9562" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7" style="background-color:#ffffff">These are the four kinds of block dispatch we currently support, and 
what a reursive factorial function looks like after transformation:</p></div></div></section>
<section class="mbr-section article content12 cid-rDNq15ll1q" id="content12-d"><div class="container"><div class="media-container-row"><div class="mbr-text counter-container col-12 col-md-8 mbr-fonts-style display-7">
<ul>
   <li> In a <em>switch dispatch</em>, each block becomes a case in a switch statement,
        and the switch is wrapped inside an infinite loop. This is the traditional
        implementation. 
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">int fac(int x) { 
  int tmp ;
  unsigned long next ;
  next = 4;
  while (1) {
    switch (next) {
    case 4: 
    if (x == 1) {
      next = 3;
    } else {
      next = 2;
    }
    break;
    case 3: return (1); break;
    case 2: tmp = fac(x - 1); next = 1; break;
    case 1: return (x * tmp); break;
    }
  }
}
</code></pre>
   <li> In a <em>goto dispatch</em>, direct gotos are used to jump between blocks. 
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">int fac(int x) { 
  int tmp ;
  goto lab4;
  lab4: 
  if (! (x == 1)) {
    goto lab2;
  }
  lab3: 
  return (1);
  lab2: 
  tmp = fac(x - 1);
  goto lab1;
  lab1: 
  return (x * tmp);
}
</code></pre>
   <li> In an <em>indirect dispatch</em>, indirect gotos through a jump table are used to switch between blocks. 
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">int fac(int x) { 
  int tmp ;
  unsigned long next ;
  static void *jumpTab[4]  = {&& lab1, && lab2, && lab3, && lab4};
  next = 4;
  goto *(jumpTab[next - 1]);
  lab4:
  if (x == 1) {
    next = 3;
  } else {
    next = 2;
  }
  goto *(jumpTab[next - 1]);
  lab3: 
  return (1);
  goto *(jumpTab[next - 1]);
  lab2: 
  tmp = fac(x - 1);
  next = 1;
  goto *(jumpTab[next - 1]);
  lab1:
  return (x * tmp);
  goto *(jumpTab[next - 1]);
}
</code></pre>
   <li> In a <em>call dispatch</em>, each block becomes its own function, and indirect calls through a 
        table of function pointers are used to switch between blocks. 
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">struct argStruct {
   int tmp ;
   int *x ;
   int returnv ;
   unsigned long next ;
};

void block_1(struct argStruct *arg ) { 
  arg->returnv = *(arg->x) * arg->tmp;
  arg->next = 5;
  return;
}

void block_2(struct argStruct *arg ) { 
  arg->tmp = fac(*(arg->x) - 1);
  arg->next = 1;
  return;
}

void block_4(struct argStruct *arg ) { 
  if (*(arg->x) == 1) {
    arg->next = 3;
  } else {
    arg->next = 2;
  }
  return;
}

void block_3(struct argStruct *arg ) { 
  arg->returnv = 1;
  arg->next = 5;
  return;
}

int fac(int x ){ 
  struct argStruct arg ;
  static void (*jumpTab[4])(struct argStruct *arg )  = {& block_1, & block_2,& block_3, & block_4};
  arg.next = 4;
  arg.x = & x;
  while (1) {
    if (arg.next > 4) {
      return (arg.returnv);
    } else {
      (*(jumpTab[arg.next - 1]))(& arg);
    }
  }
}
</code></pre>
</ul>
</div></div></div></section>

<center>
<div style="mbr-text align-left pb-3 mbr-fonts-style display-7">
<table border style="background-color:#f5f5f5;overflow-x:auto;color:black;width:80%;">
    <colgroup>
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 60%;">
    </colgroup>
<tr><th>Option</th><th>Arguments</th><th>Description</th></tr>
<tr>
<td><tt>--FlattenDispatch</tt></td>
<td><tt>switch, goto, indirect, call, *</tt></td>
<td> Dispatch method. Comma-separated list. Default=switch.
<ul>
   <li> <tt>switch</tt> = dispatch by <tt>while(1) {switch (next) {blocks}}</tt>
   <li> <tt>goto</tt> = dispatch by <tt>{labl1: block1; goto block2;}</tt>
   <li> <tt>indirect</tt> = dispatch by <tt>goto* (jtab[next])</tt>
   <li> <tt>call</tt> = each block is outlined into its own function
   <li> <tt>*</tt> = select a dispatch method at random.
</ul>
</td>
</tr>
</table>
</div>

</center>
</br>

<a class="anchor" id="conditionals">&nbsp;</a>
<br>
<h3 align=center>Conditional Branches</h3>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-c9563" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7" style="background-color:#ffffff">If the <code>--FlattenConditionalKinds=flag</code> is set, there will be no
explicit conditional tests in the code. Rather, they will be transformed
into an assembly code snippet (<code>x86</code> only, at this point) that 
does the comparison, extracts the flag register, and then the address to
jump to will be computed based on the individual flags set. Similar
encodings are available for Merge and Virtualize transformations.</p></div></div></section>

<center>
<div style="mbr-text align-left pb-3 mbr-fonts-style display-7">
<table border style="background-color:#f5f5f5;overflow-x:auto;color:black;width:80%;">
    <colgroup>
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 60%;">
    </colgroup>
<tr><th>Option</th><th>Arguments</th><th>Description</th></tr>
<tr>
<td><tt>--FlattenConditionalKinds</tt></td>
<td><tt>branch, compute, flag</tt></td>
<td> Ways to transform conditional branches. Default=branch.
<ul>
   <li> <tt>branch</tt> = Use normal branches, such as <tt>if (a>b) goto L1 else goto L2</tt>
   <li> <tt>compute</tt> = Compute the branch, such as <tt>x=(a>b); goto *(<em>expression over <tt>x</tt></em>)</tt>
   <li> <tt>flag</tt> = Compute the branch from the values of the flag register, such as <tt>asm("cmp a b;pushf;pop"); goto *(<em>expression over <tt>flag register</tt></em>)</tt>
</ul>
</td>
</tr>
</table>
</div>

</center>
</br>

<a class="anchor" id="nextobf">&nbsp;</a>
<br>
<h3 align=center>Obfuscating the Next Variable</h3>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-c9564" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7" style="background-color:#ffffff">You can use opaque predicates and anti-implicit flow transformations to further obfuscate the <code>next</code>
variable.</p></div></div></section>

<center>
<div style="mbr-text align-left pb-3 mbr-fonts-style display-7">
<table border style="background-color:#f5f5f5;overflow-x:auto;color:black;width:80%;">
    <colgroup>
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 20%;">
       <col span="1" style="width: 60%;">
    </colgroup>
<tr><th>Option</th><th>Arguments</th><th>Description</th></tr>
<tr>
<td><tt>--FlattenObfuscateNext</tt></td>
<td><tt><em><a href="top-level.html#arguments">BOOLSPEC</a></em></tt></td>
<td> Whether the dispatch variable should be obfuscated with opaque expressions or not. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenOpaqueStructs</tt></td>
<td><tt>list, array, *</tt></td>
<td> Type of opaque predicate to use. Traditionally, for this transformation, <tt>array</tt> is used. Default=array.
<ul>
   <li> <tt>list</tt> = Generate opaque expressions using linked lists
   <li> <tt>array</tt> = Generate opaque expressions using arrays
   <li> <tt>*</tt> = Same as list,array
</ul>
</td>
</tr>
<tr>
<td><tt>--FlattenImplicitFlowNext</tt></td>
<td><tt>bool</tt></td>
<td> Insert implicit flow between the computation of a an address and the subsequent indirect jump or call. This applies to <tt>call</tt> and <tt>indirect</tt> transformations only. Default=false.</td>
</tr>
<tr>
<td><tt>--FlattenImplicitFlow</tt></td>
<td><tt>S-Expression</tt></td>
<td> The type of implicit flow to insert. See <tt>--AntiTaintAnalysisImplicitFlow</tt> for a description. Default=none.</td>
</tr>
</table>
</div>

</center>
</br>


<a class="anchor" id="issues">&nbsp;</a>
<br>
<h3 align=center>Issues</h3>
<section class="mbr-section article content12 cid-rDNq15ll1q" id="content12-d"><div class="container"><div class="media-container-row"><div class="mbr-text counter-container col-12 col-md-8 mbr-fonts-style display-7">
<ul>
   <li> Consider this example taken from gcc's <code>comp-goto-1.c</code> torture test:
<center>
<pre style="text-align:left;background-color:#f0f0f0;display:inline-block;padding:20px;border:1px solid black;"><code contenteditable spellcheck="false">goto *(base_addr + insn.f1.offset);
</code></pre>
</center>
      This kind of arithmetic on the program counter is going to fail for 
      transformations that completely restructure the code, such as
      flattening.
   <li> The <code>--FlattenConditionalKinds=flag</code> transformation doesn't
      work for floats, for reasons that escape me. I think maybe floats are
      left on the stack and then there's a SEGV when the function returns,
      but who knows? <code>:(</code>
   <li> On MacOS/llvm the <code>--FlattenDispatch=call --FlattenConditionalKinds=flag</code> transformation 
      generates a segmentation fault, on Linux/gcc it does not. There are other similar issues that 
      pop up occasionally on this platform. Presumably this is due to some compiler problem related 
      to inline assembly. Update: I think this has been fixed now. Inline assembly with instructions
      that manipulate the stack pointer can apparently be problematic.
</ul>
</div></div></div></section>

<a class="anchor" id="acknowledgments">&nbsp;</a>
<br>
<h3 align=center>Acknowledgments</h3>
<section class="engine"><a href="https://mobirise.info/l">free web templates</a></section><section class="header9 cid-c9565" id="header9-h"> <div class="container"><div class="media-container-column mbr-white"><p class="mbr-text align-left pb-3 mbr-fonts-style display-7" style="background-color:#ffffff">Saumya Debray and Babak Yadegari suggested the <code>--FlattenConditionalKinds=flag</code> transformation.</p></div></div></section>

<a class="anchor" id="references">&nbsp;</a>
<br>
<h3 align=center>References</h3>
<section class="mbr-section article content12 cid-rDNq15ll1q" id="content12-d"><div class="container"><div class="media-container-row"><div class="mbr-text counter-container col-12 col-md-8 mbr-fonts-style display-7">
<ul>
   <li> Flattening first appears in Chenxi Wang's <a href="http://dependability.cs.virginia.edu/publications/wangthesis.pdf">thesis.</a>
   <li> The <a href="https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening">llvm obfuscator</a>
        supports a flattening transformation.
   <li> Laszlo and Kiss, <a href="http://www.inf.u-szeged.hu/~akiss/pub/pdf/laszlo_obfuscating.pdf">Obfuscating C++ Programs via Control Flow Flattening</a>
   <li> Udupa et al, <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.302.7805">Deobfuscation: Reverse engineering obfuscated code</a>.
</ul>
</div></div></div></section>


  <script src="assets/popper/popper.min.js"></script>
  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
  <script async src="assets/tether/tether.min.js"></script>
  <script async src="assets/dropdown/js/nav-dropdown.js"></script>
  <script async src="assets/dropdown/js/navbar-dropdown.js"></script>
  <script async src="assets/touchswipe/jquery.touch-swipe.min.js"></script>
  <script async src="assets/viewportchecker/jquery.viewportchecker.js"></script>
  <script async src="assets/smoothscroll/smooth-scroll.js"></script>
  <script async src="assets/theme/js/script.js"></script>
  
  
  <input name="animation" type="hidden">
  
</body>
</html>
