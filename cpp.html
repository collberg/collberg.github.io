
<!DOCTYPE html>
<html  >
<head>
  
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <link rel="shortcut icon" href="assets/images/tigress-white-128x101.png" type="image/x-icon">
  <meta name="description" content="Web Maker Description">
  
   <link rel="stylesheet" href="assets/web/assets/mobirise-icons/mobirise-icons.css">
  <link rel="stylesheet" href="assets/web/assets/mobirise-icons-bold/mobirise-icons-bold.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="assets/tether/tether.min.css">
  <link rel="stylesheet" href="assets/popup-overlay-plugin/style.css">
  <link rel="stylesheet" href="assets/dropdown/css/style.css">
  <link rel="stylesheet" href="assets/socicon/css/styles.css">
  <link rel="stylesheet" href="assets/theme/css/style.css">
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Rubik:300,400,500,600,700,800,900,300i,400i,500i,600i,700i,800i,900i&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Rubik:300,400,500,600,700,800,900,300i,400i,500i,600i,700i,800i,900i&display=swap"></noscript>
  <link rel="preload" as="style" href="assets/mobirise/css/mbr-additional.css"><link rel="stylesheet" href="assets/mobirise/css/mbr-additional.css" type="text/css">
  <link rel="preload" as="style" href="assets/mobirise/css/tigress.css"> <link rel="stylesheet" href="assets/mobirise/css/tigress.css" type="text/css">
  <link href="assets/prism/prism.css" rel="stylesheet" />

  
 <style>
body {
  background-color: #ffffff;
  color: #000000
}
section {
  background-color: #ffffff;
  color: #000000
}
p {
   color: #000000
}
h3 {
   color: #000000
}
code {
  font-family:     "Courier New"
                    Courier
                    monospace;
  color: black;
}

</style>
  
</head>
<body>
  
  <section class="menu cid-um5eFJALJY" once="menu" id="menu1-16">

        <nav class="navbar navbar-expand beta-menu navbar-dropdown align-items-center navbar-fixed-top navbar-toggleable-sm">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
        <div class="menu-logo">
            <div class="navbar-brand">
                <span class="navbar-logo">
                    <a href="index.html">
                         <img src="assets/images/screenshot-2024-08-20-at-14.25.07-copy-126x121.png" alt="" title="" style="height: 4.1rem;">
                    </a>
                </span>
                <span class="navbar-caption-wrap"><a class="navbar-caption text-white display-4" href="index.html">
                        Tigress</a></span>
            </div>
        </div>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown nav-right" data-app-modern-menu="true"><li class="nav-item dropdown">
                    <a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">Usage</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="quickstart.html">Quickstart<br></a><a class="text-white dropdown-item text-primary display-4" href="mergeFiles.html">File merge<br></a><a class="text-white dropdown-item text-primary display-4" href="crossCompile.html">Cross compile</a><a class="text-white dropdown-item text-primary display-4" href="recipes.html">Recipes</a><a class="text-white dropdown-item text-primary display-4" href="libraries.html">Libraries</a><a class="text-white dropdown-item text-primary display-4" href="top-level.html">Top-Level Options</a><a class="text-white dropdown-item text-primary display-4" href="plugins.html">Plugins</a><a class="text-white dropdown-item text-primary display-4" href="issues.html">Issues</a><a class="text-white dropdown-item text-primary display-4" href="tigress-test.html">Testing</a></div>
                </li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">Platforms</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="linux.html">Linux<br></a><a class="text-white dropdown-item text-primary display-4" href="macos.html">MacOS<br></a><a class="text-white dropdown-item text-primary display-4" href="windows.html">Windows<br></a><a class="text-white dropdown-item text-primary display-4" href="android.html">Android<br></a><a class="text-white dropdown-item text-primary display-4" href="wasm.html">WASM<br></a><a class="text-white dropdown-item text-primary display-4" href="cpp.html">C++<br></a></div></li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">Users</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="academics.html">For academics<br></a><a class="text-white dropdown-item text-primary display-4" href="students.html">For students<br></a><a class="text-white dropdown-item text-primary display-4" href="practitioners.html">For practitioners<br></a><a class="text-white dropdown-item text-primary display-4" href="developers.html">For developers<br></a></div></li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" aria-expanded="false" data-toggle="dropdown-submenu">News</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="news.html" aria-expanded="false">News</a><a class="text-white dropdown-item text-primary display-4" href="blog.html" aria-expanded="false">Blog</a><a class="text-white dropdown-item text-primary display-4" href="vendors.html" aria-expanded="false">Tools &amp; Vendors</a><a class="text-white dropdown-item text-primary display-4" href="update3to4.html" aria-expanded="false">Updates v3 âžž v4</a></div></li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">Transformations</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="control-transforms.html">Control</a><a class="text-white dropdown-item text-primary display-4" href="data-transforms.html">Data</a><a class="text-white dropdown-item text-primary display-4" href="functions-transforms.html">Functions</a><a class="text-white dropdown-item text-primary display-4" href="integrity-transforms.html">Integrity</a><a class="text-white dropdown-item text-primary display-4" href="antiAnalysis-transforms.html">Anti analysis</a><a class="text-white dropdown-item text-primary display-4" href="other-transforms.html">Other</a></div></li><li class="nav-item dropdown"><a class="nav-link link text-white dropdown-toggle display-4" href="#" data-toggle="dropdown-submenu" aria-expanded="false">About</a><div class="dropdown-menu"><a class="text-white dropdown-item text-primary display-4" href="about.html">History<br></a><a class="text-white dropdown-item text-primary display-4" href="FAQ.html">FAQ<br></a><a class="text-white dropdown-item text-primary display-4" href="consulting.html">Training<br></a><a class="text-white dropdown-item text-primary display-4" href="publications.html">Pubs</a></div></li><li class="nav-item"><a class="nav-link link text-white text-primary display-4" href="contact.html" aria-expanded="false"><span class="socicon socicon-mail mbr-iconfont mbr-iconfont-btn" style="color: rgb(255, 127, 159);"></span></a></li><li class="nav-item"><a class="nav-link link text-white text-primary display-4" href="tigress-download.html" aria-expanded="false"><span class="mbrib-download mbr-iconfont mbr-iconfont-btn" style="color: rgb(255, 127, 159);"></span></a></li></ul>
            
        </div>
    </nav>

</section>

<br><br><br><br>

<section class="mbr-section content4 TIGRESS-TITLE" id="content4-dz">
    <div class="container">
        <div class="media-container-row">
            <div class="title col-12 col-md-8">
                <h2 class="align-center pb-3 mbr-fonts-style display-2">
 Running Tigress on C++ Code

               </h2>
            </div>
        </div>
    </div>
</section>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Below is a proof-of-concept recipe showing how to obfuscate a C++ program (SuperTux) with Tigress,
provided to us by <a href="https://bartcoppens.be">Bart Coppens</a>. At some future date we hope to
integrate the LLVM C backend with Tigress to automate this process.

            </p>
        </div>
    </div>
</section>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
We need five steps to transform the C++ code into C, and then obfuscate with Tigress:

            </p>
        </div>
    </div>
</section>

<section class="step1 TIGRESS-OL" id="step1-dy">
    <div class="container">
        <div class="step-container">


            <div class="card separline pb-4">
                <div class="step-element d-flex">
                    <div class="step-wrapper pr-3">
                        <h3 class="step d-flex align-items-center justify-content-center">
                            1
                        </h3>
                    </div>          
                    <div class="step-text-content">
                        <p class="mbr-step-text mbr-fonts-style display-7">
     Building the right LLVM tool chain; 

                        </p>
                    </div>
                </div>
            </div>

            <div class="card separline pb-4">
                <div class="step-element d-flex">
                    <div class="step-wrapper pr-3">
                        <h3 class="step d-flex align-items-center justify-content-center">
                            2
                        </h3>
                    </div>          
                    <div class="step-text-content">
                        <p class="mbr-step-text mbr-fonts-style display-7">
     Building the (patched/hacked) LLVM C Backend; 

                        </p>
                    </div>
                </div>
            </div>

            <div class="card separline pb-4">
                <div class="step-element d-flex">
                    <div class="step-wrapper pr-3">
                        <h3 class="step d-flex align-items-center justify-content-center">
                            3
                        </h3>
                    </div>          
                    <div class="step-text-content">
                        <p class="mbr-step-text mbr-fonts-style display-7">
      Compiling Supertux with the LLVM tool chain from (1) to create an LLVM Intermediate Representation of Supertux as a whole; 

                        </p>
                    </div>
                </div>
            </div>

            <div class="card separline pb-4">
                <div class="step-element d-flex">
                    <div class="step-wrapper pr-3">
                        <h3 class="step d-flex align-items-center justify-content-center">
                            4
                        </h3>
                    </div>          
                    <div class="step-text-content">
                        <p class="mbr-step-text mbr-fonts-style display-7">
       Running the patched LLVM C Backend on the LLVM IR from (3) to create a single C file; 

                        </p>
                    </div>
                </div>
            </div>

            <div class="card separline pb-4">
                <div class="step-element d-flex">
                    <div class="step-wrapper pr-3">
                        <h3 class="step d-flex align-items-center justify-content-center">
                            5
                        </h3>
                    </div>          
                    <div class="step-text-content">
                        <p class="mbr-step-text mbr-fonts-style display-7">
      Some gentle post-processing of the single C file of (4)

                        </p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

<!-- =============================================================================================== -->

<section class="mbr-section content4 TIGRESS-SECTION" id="content4-dz">
    <div class="container">
        <div class="media-container-row">
            <div class="title col-12 col-md-8">
                <h2 class="align-center pb-3 mbr-fonts-style display-2">
 Build LLVM 17

               </h2>
            </div>
        </div>
    </div>
</section>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
From here on we will assume that everything is done in the directory <code class="language-c">/projects</code>.

            </p>
        </div>
    </div>
</section>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
If you're using Docker, do the following:

            </p>
        </div>
    </div>
</section>
<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">docker pull debian:12 ; 
docker run -v ${PWD}/projects:/projects -ti debian:12 bash 
sed -i 's/deb$/deb deb-src/' /etc/apt/sources.list.d/debian.sources 
apt-get update 
apt-get build-dep supertux 
apt-get install vim python3.11-venv
</code></pre></div>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">cd /projects 
git clone https://url.usb.m.mimecastprotect.com/s/MexdCoAWMofr6Q610i1fgCYOGkE?domain=github.com
cd llvm-project
git switch release/17.x
mkdir llvm/build
cd llvm/build
cmake -DCMAKE_BUILD_TYPE=Release \
      -DLLVM_ENABLE_DUMP=ON \
      -DLLVM_BUILD_LLVM_DYLIB=ON \
      -DLLVM_ENABLE_PROJECTS=clang \
      -DLLVM_ENABLE_ASSERTIONS=ON ..
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
If you ever need to debug things, add <code class="language-c">-DMAKE_BUILD_TYPE=Debug</code> or 
<code class="language-c">-DMAKE_BUILD_TYPE=RelWithDebInfo</code>. Then, build:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">make -j<em>number of CPU cores</em>
</code></pre></div>

<!-- =============================================================================================== -->

<section class="mbr-section content4 TIGRESS-SECTION" id="content4-dz">
    <div class="container">
        <div class="media-container-row">
            <div class="title col-12 col-md-8">
                <h2 class="align-center pb-3 mbr-fonts-style display-2">
 Build the patched LLVM C Backend

               </h2>
            </div>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">cd /projects
git clone https://url.usb.m.mimecastprotect.com/s/h9m8Cp9WNpfnp7pJBSDh7CXcChH?domain=github.com
cd llvm-cbe
git switch development
mkdir build
cd build

export PATH=/projects/llvm-project/llvm/build/bin/:$PATH

cmake ..

make
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
If you get a build error here about undefined reference to <code class="language-c">`typeinfo for llvm::cl::GenericOptionValue'</code>, 
add the following at the end of <code class="language-c">../tools/llvm-cbe/CMakeLists.txt</code>:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">if (NOT ${LLVM_ENABLE_RTTI})
   target_compile_options(llvm-cbe PRIVATE "-fno-rtti")
   target_link_options(llvm-cbe PRIVATE "-fno-rtti")
endif()
</code></pre></div>

<!-- =============================================================================================== -->

<section class="mbr-section content4 TIGRESS-SECTION" id="content4-dz">
    <div class="container">
        <div class="media-container-row">
            <div class="title col-12 col-md-8">
                <h2 class="align-center pb-3 mbr-fonts-style display-2">
 Compiling single LLVM IR file for Supertux with the right LLVM tool chain

               </h2>
            </div>
        </div>
    </div>
</section>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
First, set up a python venv for wllvm. This  is a tool that allows for creating objects and binaries with 
LLVM IR embedded inside them. This can be used for link-time optimization but also for our purposes:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">cd /projects
python3 -m venv venv-wllvm 
. venv-wllvm/bin/activate
pip3 install wllvm
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Next, set up the aliases and exports such that wllvm works correctly. This still depends on the active venv and the
PATH being set correctly from earlier:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">export LLVM_COMPILER=clang
export LLVM_COMPILER_PATH=/projects/llvm-project/llvm/build/bin/
alias wllvm="wllvm -g"
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Next, get Supertux. In this example, we built on a Debian 12 machine, 
which at the time had supertux-0.6.3. Get the dependencies to build it:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">sudo apt-get build-dep supertux

cd /projects
apt-get source supertux
cd supertux-0.6.3/

mkdir build
cd build
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Next, configure Supertux to build with wllvm (the other build options were 
based on those from Debian), and then build it:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">CC=wllvm CXX=wllvm++ CFLAGS=-g CXXFLAGS=-g \
     cmake -DBUILD_SHARED_LIBS=OFF \
           -DCMAKE_BUILD_RPATH_USE_ORIGIN=ON \
           -DENABLE_BOOST_STATIC_LIBS=OFF \
           -DUSE_SYSTEM_PHYSFS=ON \
           -DIS_SUPERTUX_RELEASE=ON ..
make -j <em>number of CPU cores</em>
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
This might output a few warnings, but you should now have a supertux2 binary. 
This binary will also contain info to get our LLVM IR file from, which we extract as follows:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">extract-bc --manifest supertux2 
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
This results in <code class="language-c">supertux2.bc</code>, which is the LLVM bitcode file with the IR in. 
As the C backend starts from textual disassembly of that IR, we first disassemble it:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">llvm-dis supertux2.bc 
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
This  results in <code class="language-c">supertux2.ll</code>. Finally, we prepare for running supertux later on:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">make install
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
This will install the data files in /usr/local. 
However, if we build our merged file later on in the build directory and run it from there, 
it will expect those data files in the build directory. One possibility is to change the PREFIX 
of cmake where it installs, but instead we just do the following:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">make install
mkdir -p /projects/supertux-0.6.3/build/share/games
cp -a /usr/local/share/games/supertux2 /projects/supertux-0.6.3/build/share/games/
</code></pre></div>

<!-- =============================================================================================== -->

<section class="mbr-section content4 TIGRESS-SECTION" id="content4-dz">
    <div class="container">
        <div class="media-container-row">
            <div class="title col-12 col-md-8">
                <h2 class="align-center pb-3 mbr-fonts-style display-2">
 Run the patched LLVM C Backend to create a C file

               </h2>
            </div>
        </div>
    </div>
</section>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Do the following:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">/projects/llvm-cbe/build/tools/llvm-cbe/llvm-cbe supertux2.ll
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
This results in <code class="language-c">supertux2.cbe.c</code>.

            </p>
        </div>
    </div>
</section>

<!-- =============================================================================================== -->

<section class="mbr-section content4 TIGRESS-SECTION" id="content4-dz">
    <div class="container">
        <div class="media-container-row">
            <div class="title col-12 col-md-8">
                <h2 class="align-center pb-3 mbr-fonts-style display-2">
 Some post-processing and then building and linking the final file

               </h2>
            </div>
        </div>
    </div>
</section>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
The C backend helpfully adds <code class="language-c">#line</code> statements so that the lines of the C file 
get mapped back to the original source files. This is probably useful when debugging a 
crash that would also be in the original code, but definitely not useful in debugging 
the case where it is the transpiled code that is broken. So first create a file without 
the line statements:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">grep -v '#line' supertux2.cbe.c > supertux2.cbe_noline.c
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Create an object file:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">gcc -g -Wno-discarded-qualifiers -std=c99 -o supertux2_cbe.o -c supertux2.cbe_noline.c
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Now, here we arrive at a fragile issue: the exception handling hack. If the above code would not 
compile due to errors related to <code class="language-c">'cbe_get_landingpad'</code> that should return <code class="language-c">'l_unnamed_1'</code>
(or something similar), edit the <code class="language-c">supertux2.cbe_noline.c</code> and change

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre><code class="language-c">struct cbe_landingpad cbe_get_landingpad() {
    struct cbe_landingpad r; 
    r.field1 = 1; 
    r.field0 = cbe_exception.o; 
    return r; 
}
void __attribute__((noreturn)) 
   __cbe_resume(struct cbe_landingpad l) __attribute__((noreturn)) {
    longjmp(ExceptionStates[--jmp_idx].buf, 1); 
}
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
into

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre><code class="language-c">struct l_unnamed_1 cbe_get_landingpad() { 
   struct l_unnamed_1 r; 
   r.field1 = 1; 
   r.field0 = cbe_exception.o; 
   return r; 
}
void __attribute__((noreturn)) 
   __cbe_resume(struct l_unnamed_1 l) { 
   longjmp(ExceptionStates[--jmp_idx].buf, 1); 
}
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Again, it might instead be something like <code class="language-c">l_unnamed_1</code> that you then have to use instead.
It might be that you have to remove the second <code class="language-c">__attribute__((noreturn))</code> regardless.

Similarly, if it complains about <code class="language-c">setjmp/longjmp</code>, edit the file as follows. 
Search for and delete the following 4 lines:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre><code class="language-c">#define longjmp _longjmp
#define setjmp _setjmp
uint32_t _setjmp(void* _147370) __ATTRIBUTELIST__((nothrow, returns_twice));
__noreturn void longjmp(void* _147371, uint32_t _147372) __ATTRIBUTELIST__((nothrow));
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Note that the numbered argument names might differ. 

            </p>
        </div>
    </div>
</section>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Finally, link the file:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">g++ -o supertux2_cbe supertux2_cbe.o \
    -L/projects/supertux-0.6.3/build-wllvm-14.x/SDL_ttf/lib  \
   -Wl,-rpath,"\$ORIGIN/SDL_ttf/lib:" libsupertux2_lib.a \
   /usr/lib/x86_64-linux-gnu/libboost_filesystem.so.1.74.0 \
   /usr/lib/x86_64-linux-gnu/libboost_locale.so.1.74.0 \
   /usr/lib/x86_64-linux-gnu/libboost_chrono.so.1.74.0 \
   /usr/lib/x86_64-linux-gnu/libboost_thread.so.1.74.0 \
   /usr/lib/x86_64-linux-gnu/libboost_atomic.so.1.74.0 \
   -lSDL2 -lSDL2_image -lSDL2 -lSDL2_image SDL_ttf//lib/libSDL2_ttf.a \
   -lfreetype -lharfbuzz -lfribidi -lraqm \
   squirrel/ex/lib/libsquirrel_static.a \
   squirrel/ex/lib/libsqstdlib_static.a \
   tinygettext//lib/libtinygettext.a \
   libsexp.a libsavepng.a -lpng \
   libpartio_zip_lib.a \
   -lz -lopenal -lvorbisfile -lvorbis -logg \
   /usr/lib/x86_64-linux-gnu/libboost_system.so.1.74.0 \
   /usr/lib/x86_64-linux-gnu/libboost_date_time.so.1.74.0 \
   -lphysfs -lGL -lGLU \
   /usr/lib/x86_64-linux-gnu/libGLEW.so \
   -lcurl -latomic
</code></pre></div>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
This link statement is basically adapted from what you would get when linking the original Supertux binary, which you can find out with 'make VERBOSE=1'

            </p>
        </div>
    </div>
</section>


<section class="header9 TIGRESS-P" id="header9-dw">
    <div class="container">
        <div class="media-container-column mbr-white">
            <p class="mbr-text align-left pb-3 mbr-fonts-style display-7">
Now you should be able to start <code class="language-c">./supertux2_cbe</code> and it should run. Now, you can finally apply Tigress:

            </p>
        </div>
    </div>
</section>

<div class="container">
<pre style="box-shadow: -5px 0 0 0 red, 0 0 0 1px #dfdfdf"><code class="language-bash">tigress \
   --Verbosity=1 \
   --Environment=x86_64:Linux:Gcc:12.2 \
   --Transform=Virtualize \
      --Functions=_ZN13ScreenManager9loop_iterEv \
      --VirtualizeDispatch=direct \
   --Transform=Flatten \
      --Functions=_ZN13ScreenManager4drawER10CompositorRNS_9FPS_StatsE \
   --Transform=EncodeArithmetic \
      --Functions=main,_ZN4Main3runEiPPc \
   --out=supertux2.cbe_noline_tigress_3_3_1_actuallyobfuscated.c \
   supertux2.cbe_noline_atomicandmorehacks.c
</code></pre></div>





  <script src="assets/popper/popper.min.js"></script>
  <script src="assets/web/assets/jquery/jquery.min.js"></script>
  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/tether/tether.min.js"></script>
  <script src="assets/smoothscroll/smooth-scroll.js"></script>
  <script src="assets/dropdown/js/nav-dropdown.js"></script>
  <script src="assets/dropdown/js/navbar-dropdown.js"></script>
  <script src="assets/touchswipe/jquery.touch-swipe.min.js"></script>
  <script src="assets/theme/js/script.js"></script>
  <script src="assets/prism/prism.js"></script>
  
</body>
</html>
